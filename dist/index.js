"use strict";var _slicedToArray=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var a=[],r=!0,n=!1,i=void 0;try{for(var o,c=e[Symbol.iterator]();!(r=(o=c.next()).done)&&(a.push(o.value),!t||a.length!==t);r=!0);}catch(e){n=!0,i=e}finally{try{!r&&c.return&&c.return()}finally{if(n)throw i}}return a}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function r(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,a){return t&&r(e.prototype,t),a&&r(e,a),e}}();function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,a=Array(e.length);t<e.length;t++)a[t]=e[t];return a}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var CacheScope,graphql_1=require("graphql");!function(e){e.Public="PUBLIC",e.Private="PRIVATE"}(CacheScope=exports.CacheScope||(exports.CacheScope={}));var CacheControlExtension=function(){function t(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,t),this.options=e,this.hints=new Map,this.defaultMaxAge=e.defaultMaxAge||0}return _createClass(t,[{key:"willResolveField",value:function(e,t,a,r){var n=this,i={},o=graphql_1.getNamedType(r.returnType);(o instanceof graphql_1.GraphQLObjectType||o instanceof graphql_1.GraphQLInterfaceType)&&o.astNode&&(i=mergeHints(i,cacheHintFromDirectives(o.astNode.directives)));var c=r.parentType.getFields()[r.fieldName];c.astNode&&(i=mergeHints(i,cacheHintFromDirectives(c.astNode.directives))),(o instanceof graphql_1.GraphQLObjectType||o instanceof graphql_1.GraphQLInterfaceType||!r.path.prev)&&void 0===i.maxAge&&(i.maxAge=this.defaultMaxAge),void 0===i.maxAge&&void 0===i.scope||this.addHint(r.path,i),r.cacheControl={setCacheHint:function(e){n.addHint(r.path,e)},cacheHint:i}}},{key:"addHint",value:function(e,t){var a=this.hints.get(e);a?this.hints.set(e,mergeHints(a,t)):this.hints.set(e,t)}},{key:"format",value:function(){if(!1===this.options.stripFormattedExtensions)return["cacheControl",{version:1,hints:Array.from(this.hints).map(function(e){var t=_slicedToArray(e,2),a=t[0],r=t[1];return Object.assign({path:[].concat(_toConsumableArray(graphql_1.responsePathAsArray(a)))},r)})}]}},{key:"willSendResponse",value:function(e){if(this.options.calculateHttpHeaders&&e.graphqlResponse.http){var t=this.computeOverallCachePolicy();t&&e.graphqlResponse.http.headers.set("Cache-Control","s-maxage="+t.maxAge+", max-age="+t.maxAge+", "+t.scope.toLowerCase())}}},{key:"overrideOverallCachePolicy",value:function(e){this.overallCachePolicyOverride=e}},{key:"computeOverallCachePolicy",value:function(){if(this.overallCachePolicyOverride)return this.overallCachePolicyOverride;var e=void 0,t=CacheScope.Public,a=!0,r=!1,n=void 0;try{for(var i,o=this.hints.values()[Symbol.iterator]();!(a=(i=o.next()).done);a=!0){var c=i.value;void 0!==c.maxAge&&(e=void 0!==e?Math.min(e,c.maxAge):c.maxAge),c.scope===CacheScope.Private&&(t=CacheScope.Private)}}catch(e){r=!0,n=e}finally{try{!a&&o.return&&o.return()}finally{if(r)throw n}}return e?{maxAge:e,scope:t}:void 0}}]),t}();function cacheHintFromDirectives(e){if(e){var t=e.find(function(e){return"cacheControl"===e.name.value});if(t&&t.arguments){var a=t.arguments.find(function(e){return"maxAge"===e.name.value}),r=t.arguments.find(function(e){return"scope"===e.name.value});return{maxAge:a&&a.value&&"IntValue"===a.value.kind?parseInt(a.value.value):void 0,scope:r&&r.value&&"EnumValue"===r.value.kind?r.value.value:void 0}}}}function mergeHints(e,t){return t?{maxAge:void 0!==t.maxAge?t.maxAge:e.maxAge,scope:t.scope||e.scope}:e}exports.CacheControlExtension=CacheControlExtension;
